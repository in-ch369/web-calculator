name: Web Calculator

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GITHUB_USERNAME: ${{ github.repository_owner }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests with pytest
      run: |
        python -m pytest tests/unit_tests/ -v --junitxml=junit-unit-${{ matrix.python-version }}.xml --cov=calculator --cov-report=xml
    
    - name: Run functional tests
      run: |
        # å¯åŠ¨åº”ç”¨
        python app.py &
        APP_PID=$!
        
        # ç­‰å¾…åº”ç”¨å¯åŠ¨
        sleep 10
        
        # è¿è¡ŒåŠŸèƒ½æµ‹è¯•
        python -m pytest tests/functional_tests/ -v --junitxml=junit-func-${{ matrix.python-version }}.xml
        
        # åœæ­¢åº”ç”¨
        kill $APP_PID
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit-*.xml
          coverage.xml
        retention-days: 7

  build:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/'))
  
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=sha,prefix={{branch}}-,format=short
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          GIT_COMMIT=${{ github.sha }}

  deploy:
    name: Blue-Green Deployment
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: http://localhost

    
    steps:
    - name: Install sshpass for password login
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate deployment tag
      id: vars
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "DEPLOY_TAG=sha-$SHORT_SHA" >> $GITHUB_ENV
        echo "IMAGE_FULL_NAME=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-$SHORT_SHA" >> $GITHUB_ENV
  
    - name: Prepare deployment script
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Starting blue-green deployment..."
        echo "Image: ${{ env.IMAGE_FULL_NAME }}"
        echo "Deploy tag: ${{ env.DEPLOY_TAG }}"
        
        cd /opt/web-calculator
        
        # æ£€æŸ¥å½“å‰æ´»åŠ¨é¢œè‰²
        if docker-compose ps app_blue | grep -q "Up" && grep -q "max_fails" nginx/conf.d/default.conf | grep -q "app_blue"; then
          CURRENT_COLOR="blue"
          NEXT_COLOR="green"
        else
          CURRENT_COLOR="green"
          NEXT_COLOR="blue"
        fi
        
        echo "Current active: $CURRENT_COLOR"
        echo "Deploying to: $NEXT_COLOR"
        
        # æ›´æ–°ç¯å¢ƒå˜é‡
        echo "GITHUB_USERNAME=${{ env.GITHUB_USERNAME }}" > .env
        if [ "$NEXT_COLOR" = "blue" ]; then
          echo "BLUE_TAG=${{ env.DEPLOY_TAG }}" >> .env
          echo "GREEN_TAG=latest" >> .env
        else
          echo "BLUE_TAG=latest" >> .env
          echo "GREEN_TAG=${{ env.DEPLOY_TAG }}" >> .env
        fi
        
        # æ‹‰å–æ–°é•œåƒ
        echo "Pulling new image..."
        docker-compose pull app_${NEXT_COLOR}
        
        # å¯åŠ¨æ–°ç‰ˆæœ¬
        echo "Starting new version..."
        docker-compose up -d app_${NEXT_COLOR}
        
        # ç­‰å¾…å¥åº·æ£€æŸ¥
        echo "Waiting for health check..."
        MAX_RETRIES=30
        for i in $(seq 1 $MAX_RETRIES); do
          if docker-compose ps app_${NEXT_COLOR} | grep -q "(healthy)"; then
            echo "New version is healthy"
            break
          fi
          if [ $i -eq $MAX_RETRIES ]; then
            echo "Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi
          echo "Attempt $i/$MAX_RETRIES: Waiting..."
          sleep 2
        done
        
        # åˆ‡æ¢æµé‡
        echo "Switching traffic..."
        if [ "$NEXT_COLOR" = "green" ]; then
          sed -i 's/server app_blue:5000 max_fails=1 fail_timeout=5s;/server app_blue:5000;/' nginx/conf.d/default.conf
          sed -i 's/server app_green:5000;/server app_green:5000 max_fails=1 fail_timeout=5s;/' nginx/conf.d/default.conf
        else
          sed -i 's/server app_green:5000 max_fails=1 fail_timeout=5s;/server app_green:5000;/' nginx/conf.d/default.conf
          sed -i 's/server app_blue:5000;/server app_blue:5000 max_fails=1 fail_timeout=5s;/' nginx/conf.d/default.conf
        fi
        
        # é‡æ–°åŠ è½½Nginx
        echo "Reloading nginx..."
        docker-compose exec -T proxy nginx -s reload
        
        # ç­‰å¾…æ—§ç‰ˆæœ¬åœæ­¢ï¼ˆå¯é€‰ï¼‰
        echo "Stopping old version in 60 seconds..."
        (sleep 60 && docker-compose stop app_${CURRENT_COLOR}) &
        
        # éªŒè¯éƒ¨ç½²
        echo "Verifying deployment..."
        sleep 5
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/health)
        if [ "$RESPONSE" = "200" ]; then
          echo "âœ… Deployment successful!"
          echo "Active version: $NEXT_COLOR"
        else
          echo "âŒ Deployment verification failed"
          exit 1
        fi
        EOF
        
        chmod +x deploy.sh

    - name: Check network connectivity
      run: |
        echo "æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."
        
        # æµ‹è¯•ping
        if ping -c 1 -W 5 "$VM_HOST" 2>/dev/null; then
          echo "âœ“ PingæˆåŠŸ"
        else
          echo "âœ— Pingå¤±è´¥"
        fi
        
        # æµ‹è¯•ç«¯å£
        if nc -zv -w 5 "$VM_HOST" 22 2>/dev/null; then
          echo "âœ“ ç«¯å£22å¯è¾¾"
        else
          echo "âœ— ç«¯å£22ä¸å¯è¾¾"
        fi
        
        # æµ‹è¯•DNS
        nslookup "$VM_HOST" 2>/dev/null || echo "DNSè§£æå¤±è´¥"
    
    - name: Test SSH connection to VM
      env:
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
      run: |
        echo "Testing connection to $VM_USER@$VM_HOST..."
        
        # å¢åŠ è¯¦ç»†è¾“å‡º
        set -x
        
        # æµ‹è¯•è¿æ¥ - è¿™ä¸€è¡Œå®Œå…¨ä¿®æ­£
        timeout 30s sshpass -p "$VM_PASSWORD" ssh -vvv \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          -o LogLevel=ERROR \
          "$VM_USER@$VM_HOST" \
          "echo 'SSHè¿æ¥æˆåŠŸ'; whoami; hostname; pwd"
        
        if [ $? -eq 0 ]; then
          echo "SSHè¿æ¥æµ‹è¯•æˆåŠŸ"
        else
          echo "SSHè¿æ¥æµ‹è¯•å¤±è´¥"
          exit 1
        fi
        
        # åˆ›å»ºç›®å½•
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          $VM_USER@${{ secrets.VM_HOST }} \
          "sudo mkdir -p /opt/web-calculator && sudo chown -R $VM_USER:$VM_USER /opt/web-calculator"
        
        # å¤åˆ¶æ–‡ä»¶
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          deploy.sh $VM_USER@${{ secrets.VM_HOST }}:/tmp/deploy.sh
        
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          docker-compose.yml $VM_USER@${{ secrets.VM_HOST }}:/opt/web-calculator/
        
        # å¤åˆ¶ nginx é…ç½®ï¼Œç¡®ä¿ç›®å½•å­˜åœ¨
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          $VM_USER@${{ secrets.VM_HOST }} \
          "mkdir -p /opt/web-calculator/nginx/conf.d"
        
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          nginx/conf.d/default.conf \
          $VM_USER@${{ secrets.VM_HOST }}:/opt/web-calculator/nginx/conf.d/
        
        echo "æ–‡ä»¶å¤åˆ¶å®Œæˆ"
    
    - name: Execute deployment
      env:
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        GHCR_TOKEN: ${{ secrets.CR_PAT }}
        GITHUB_USERNAME: ${{ github.repository_owner }}
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
        echo "ä½¿ç”¨é•œåƒ: ghcr.io/in-ch369/web-calculator:$DEPLOY_TAG"
        echo "GitHub Token é•¿åº¦: ${#GHCR_TOKEN}"
        
        # åˆ›å»ºä¸€ä¸ªæ–°çš„éƒ¨ç½²è„šæœ¬ï¼ŒåŒ…å«å®Œæ•´çš„è®¤è¯é€»è¾‘
        cat > /tmp/deploy_fixed.sh << 'DEPLOY_SCRIPT'
        #!/bin/bash
        set -e
        
        echo "=== éƒ¨ç½²å¼€å§‹ ==="
        
        # 1. æ˜¾ç¤ºç¯å¢ƒå˜é‡ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        echo "DEPLOY_TAG: $DEPLOY_TAG"
        echo "GITHUB_USERNAME: $GITHUB_USERNAME"
        echo "IMAGE_FULL: $IMAGE_FULL"
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        # 2. å¼ºåˆ¶ç™»å½•åˆ° GitHub Container Registry
        echo "=== æ­¥éª¤1: ç™»å½•åˆ° ghcr.io ==="
        
        # æ¸…ç†æ—§çš„è®¤è¯
        rm -f ~/.docker/config.json
        
        # ä½¿ç”¨å¤šç§æ–¹å¼ç™»å½•
        if [ -n "$GHCR_TOKEN" ]; then
            echo "æ–¹æ³•1: ä½¿ç”¨ GHCR_TOKEN ç™»å½•"
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
            
            if [ $? -eq 0 ]; then
                echo "âœ… æ–¹æ³•1 ç™»å½•æˆåŠŸ"
            else
                echo "âŒ æ–¹æ³•1 ç™»å½•å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2"
                
                # æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ docker login
                docker login ghcr.io -u "$GITHUB_USERNAME" -p "$GHCR_TOKEN"
                
                if [ $? -eq 0 ]; then
                    echo "âœ… æ–¹æ³•2 ç™»å½•æˆåŠŸ"
                else
                    echo "âŒ æ‰€æœ‰ç™»å½•æ–¹æ³•éƒ½å¤±è´¥"
                    echo "Token å‰10ä½: ${GHCR_TOKEN:0:10}..."
                    exit 1
                fi
            fi
        else
            echo "âŒ GHCR_TOKEN æœªè®¾ç½®"
            exit 1
        fi
        
        # 3. éªŒè¯ç™»å½•
        echo "=== æ­¥éª¤2: éªŒè¯ç™»å½•çŠ¶æ€ ==="
        if grep -q "ghcr.io" ~/.docker/config.json 2>/dev/null; then
            echo "âœ… å·²æˆåŠŸç™»å½•åˆ° ghcr.io"
        else
            echo "âŒ ç™»å½•éªŒè¯å¤±è´¥"
            exit 1
        fi
        
        # 4. æµ‹è¯•æ‹‰å–é•œåƒ
        echo "=== æ­¥éª¤3: æµ‹è¯•æ‹‰å–é•œåƒ ==="
        echo "å°è¯•æ‹‰å–: $IMAGE_FULL"
        
        docker pull "$IMAGE_FULL"
        
        if [ $? -eq 0 ]; then
            echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
        else
            echo "âŒ é•œåƒæ‹‰å–å¤±è´¥"
            echo "å°è¯•æŸ¥çœ‹å¯ç”¨é•œåƒ..."
            
            # æŸ¥çœ‹ä»“åº“ä¸­çš„é•œåƒæ ‡ç­¾
            curl -s -H "Authorization: Bearer $GHCR_TOKEN" \
              "https://ghcr.io/v2/in-ch369/web-calculator/tags/list"
            exit 1
        fi
        
        # 5. è¿›å…¥é¡¹ç›®ç›®å½•
        echo "=== æ­¥éª¤4: è¿›å…¥é¡¹ç›®ç›®å½• ==="
        cd /opt/web-calculator
        
        # 6. æ£€æŸ¥å½“å‰æ´»è·ƒç‰ˆæœ¬
        echo "=== æ­¥éª¤5: æ£€æŸ¥å½“å‰æ´»è·ƒç‰ˆæœ¬ ==="
        if docker ps --filter "name=app_blue" --format "{{.Names}}" | grep -q "app_blue" && \
          grep -q "app_blue.*max_fails" nginx/conf.d/default.conf 2>/dev/null; then
            CURRENT="blue"
            NEXT="green"
        else
            CURRENT="green"
            NEXT="blue"
        fi
        
        echo "å½“å‰æ´»è·ƒ: $CURRENT"
        echo "éƒ¨ç½²åˆ°: $NEXT"
        
        # 7. æ›´æ–°ç¯å¢ƒå˜é‡
        echo "=== æ­¥éª¤6: æ›´æ–°ç¯å¢ƒå˜é‡ ==="
        if [ "$NEXT" = "blue" ]; then
            echo "BLUE_TAG=$DEPLOY_TAG" > .env
            echo "GREEN_TAG=latest" >> .env
        else
            echo "BLUE_TAG=latest" > .env
            echo "GREEN_TAG=$DEPLOY_TAG" >> .env
        fi
        echo "DEPLOY_TAG=$DEPLOY_TAG" >> .env
        echo "GITHUB_USERNAME=$GITHUB_USERNAME" >> .env
        
        cat .env
        
        # 8. æ‹‰å–æŒ‡å®šæ ‡ç­¾çš„é•œåƒ
        echo "=== æ­¥éª¤7: æ‹‰å–éƒ¨ç½²é•œåƒ ==="
        docker-compose pull "app_$NEXT"
        
        # 9. å¯åŠ¨æ–°å®¹å™¨
        echo "=== æ­¥éª¤8: å¯åŠ¨æ–°å®¹å™¨ ==="
        docker-compose up -d "app_$NEXT"
        
        # 10. ç­‰å¾…å¥åº·æ£€æŸ¥
        echo "=== æ­¥éª¤9: å¥åº·æ£€æŸ¥ ==="
        for i in {1..30}; do
            if docker-compose ps "app_$NEXT" | grep -q "(healthy)"; then
                echo "âœ… å®¹å™¨å¥åº·"
                break
            fi
            
            if [ $i -eq 30 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶"
                docker-compose logs "app_$NEXT"
                exit 1
            fi
            
            echo "ç­‰å¾…... ($i/30)"
            sleep 2
        done
        
        # 11. æ›´æ–° Nginx é…ç½®
        echo "=== æ­¥éª¤10: æ›´æ–° Nginx é…ç½® ==="
        # ç§»é™¤æ‰€æœ‰ max_fails
        sed -i 's/ max_fails=[0-9]\+ fail_timeout=[0-9]\+s//g' nginx/conf.d/default.conf
        # ä¸ºæ–°çš„æ´»è·ƒç‰ˆæœ¬æ·»åŠ  max_fails
        sed -i "s/server app_$NEXT:5000;/server app_$NEXT:5000 max_fails=1 fail_timeout=5s;/" nginx/conf.d/default.conf
        
        # 12. é‡æ–°åŠ è½½ Nginx
        echo "=== æ­¥éª¤11: é‡æ–°åŠ è½½ Nginx ==="
        docker-compose exec -T proxy nginx -s reload
        
        # 13. åœæ­¢æ—§å®¹å™¨
        echo "=== æ­¥éª¤12: åœæ­¢æ—§å®¹å™¨ ==="
        docker-compose stop "app_$CURRENT"
        
        # 14. éªŒè¯éƒ¨ç½²
        echo "=== æ­¥éª¤13: éªŒè¯éƒ¨ç½² ==="
        sleep 3
        
        if curl -f -s http://localhost/health > /dev/null; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "æ´»è·ƒç‰ˆæœ¬: $NEXT"
            echo "é•œåƒç‰ˆæœ¬: $DEPLOY_TAG"
        else
            echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š"
            docker-compose start "app_$CURRENT"
            docker-compose exec -T proxy nginx -s reload
            exit 1
        fi
        
        echo "=== éƒ¨ç½²å®Œæˆ ==="
        DEPLOY_SCRIPT
        
        chmod +x /tmp/deploy_fixed.sh
        
        # ä¸Šä¼ æ–°çš„éƒ¨ç½²è„šæœ¬
        echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²è„šæœ¬..."
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          /tmp/deploy_fixed.sh $VM_USER@$VM_HOST:/tmp/deploy_fixed.sh
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼Œä¼ é€’æ‰€æœ‰å¿…è¦çš„ç¯å¢ƒå˜é‡
        echo "ğŸš€ æ‰§è¡Œéƒ¨ç½²..."
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=30 \
          $VM_USER@$VM_HOST << EOF
        export GHCR_TOKEN='$GHCR_TOKEN'
        export GITHUB_USERNAME='$GITHUB_USERNAME'
        export DEPLOY_TAG='$DEPLOY_TAG'
        export IMAGE_FULL='ghcr.io/in-ch369/web-calculator:$DEPLOY_TAG'
        bash /tmp/deploy_fixed.sh
        EOF
              
              if [ $? -eq 0 ]; then
                  echo "âœ… éƒ¨ç½²æ‰§è¡Œå®Œæˆ"
              else
                  echo "âŒ éƒ¨ç½²æ‰§è¡Œå¤±è´¥"
                  exit 1
              fi
  
  notification:
    name: Send Notification
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Send success notification
      if: success()
      run: |
        echo "âœ… CI/CD Pipeline completed successfully!"
        echo "Deployment URL: http://${{ secrets.VM_HOST }}"
    
    - name: Send failure notification
      if: failure()
      run: |
        echo "âŒ CI/CD Pipeline failed!"
        echo "Check GitHub Actions logs for details."
name: Web Calculator CI/CD

on:
  push:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest requests
    
    - name: Run unit tests
      run: |
        python -m pytest tests/unit_tests/ -v
    
    - name: Run functional tests (with longer timeout)
      run: |
        # å¯åŠ¨åº”ç”¨å¹¶è®°å½•æ—¥å¿—
        echo "å¯åŠ¨åº”ç”¨..."
        python app.py > app.log 2>&1 &
        APP_PID=$!
        
        echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
        # ç­‰å¾…æ›´é•¿æ—¶é—´
        sleep 15
        
        # æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
        if ps -p $APP_PID > /dev/null; then
          echo "åº”ç”¨è¿›ç¨‹è¿è¡Œä¸­"
        else
          echo "åº”ç”¨è¿›ç¨‹å·²é€€å‡º"
          cat app.log
          exit 1
        fi
        
        # å°è¯•è¿æ¥
        echo "æµ‹è¯•è¿æ¥..."
        if curl -s -f --max-time 5 http://localhost:5000/health > /dev/null; then
          echo "âœ… åº”ç”¨å·²å°±ç»ª"
          # è¿è¡Œæµ‹è¯•
          python -m pytest tests/functional_tests/ -v --tb=short
        else
          echo "âŒ åº”ç”¨æœªå“åº”"
          echo "=== åº”ç”¨æ—¥å¿— ==="
          tail -50 app.log
          exit 1
        fi
        
        # æ¸…ç†
        kill $APP_PID 2>/dev/null || true

build:
  name: Build Docker Image
  needs: test
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main'
  
  steps:
  - uses: actions/checkout@v4
  
  - name: Login to GitHub Container Registry
    uses: docker/login-action@v3
    with:
      registry: ghcr.io
      username: ${{ github.actor }}
      password: ${{ secrets.CR_PAT }}
    
  - name: Build and push
    run: |
      docker build -t ghcr.io/${{ github.repository }}:latest .
      docker push ghcr.io/${{ github.repository }}:latest

deploy:
  name: Deploy to VM
  needs: build
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main'
    
  steps:
  - name: Install sshpass
    run: sudo apt-get install -y sshpass
    
  - name: Create and execute deployment script
    env:
      VM_HOST: ${{ secrets.VM_HOST }}
      VM_USER: ${{ secrets.VM_USER }}
      VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
    run: |
      cat > /tmp/deploy_blue_green.sh << 'EOF'
      #!/bin/bash
      set -e
      
      echo "========================================"
      echo "      è“ç»¿éƒ¨ç½²å¼€å§‹"
      echo "========================================"
      echo "éƒ¨ç½²æ—¶é—´: $(date)"
      echo "é•œåƒç‰ˆæœ¬: ${{ env.SHORT_SHA }}"
      echo "è“è‰²ç«¯å£: ${{ env.BLUE_PORT }}"
      echo "ç»¿è‰²ç«¯å£: ${{ env.GREEN_PORT }}"
      echo ""
      
      # 1. ç™»å½•åˆ°GitHubå®¹å™¨ä»“åº“
      echo "æ­¥éª¤1: ç™»å½•åˆ°GitHubå®¹å™¨ä»“åº“"
      echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u '${{ github.actor }}' --password-stdin
      echo "âœ… Dockerç™»å½•æˆåŠŸ"
      echo ""
      
      # 2. æ‹‰å–é•œåƒ
      echo "æ­¥éª¤2: æ‹‰å–Dockeré•œåƒ"
      IMAGE="ghcr.io/${{ github.repository }}"
      
      # æ‹‰å–æ–°ç‰ˆæœ¬ï¼ˆç”¨äºç»¿è‰²å®¹å™¨ï¼‰
      echo "æ‹‰å–æ–°ç‰ˆæœ¬é•œåƒ: latest"
      docker pull "$IMAGE":latest
      echo "âœ… æ‹‰å–latesté•œåƒæˆåŠŸ"
      
      # æ‹‰å–commitç‰ˆæœ¬ï¼ˆç”¨äºè“è‰²å®¹å™¨ï¼‰
      echo "æ‹‰å–commitç‰ˆæœ¬é•œåƒ: ${{ env.SHORT_SHA }}"
      docker pull "$IMAGE":${{ env.SHORT_SHA }}
      echo "âœ… æ‹‰å–${{ env.SHORT_SHA }}é•œåƒæˆåŠŸ"
      echo ""
      
      # 3. åœæ­¢æ—§æœåŠ¡
      echo "æ­¥éª¤3: åœæ­¢æ—§æœåŠ¡"
      docker-compose down 2>/dev/null || true
      echo "âœ… æ—§æœåŠ¡å·²åœæ­¢"
      echo ""
      
      # 4. å¯åŠ¨æ–°æœåŠ¡
      echo "æ­¥éª¤4: å¯åŠ¨è“ç»¿éƒ¨ç½²"
      docker-compose up -d --force-recreate
      echo "âœ… æœåŠ¡å¯åŠ¨å‘½ä»¤å·²æ‰§è¡Œ"
      echo ""
      
      # 5. ç­‰å¾…æœåŠ¡å¯åŠ¨
      echo "æ­¥éª¤5: ç­‰å¾…æœåŠ¡å¯åŠ¨"
      for i in {1..30}; do
        BLUE_UP=$(docker ps | grep -c "webcalc_blue" || true)
        GREEN_UP=$(docker ps | grep -c "webcalc_green" || true)
        
        if [ $BLUE_UP -eq 1 ] && [ $GREEN_UP -eq 1 ]; then
          echo "âœ… è“ç»¿å®¹å™¨éƒ½å·²å¯åŠ¨"
          break
        fi
        
        if [ $i -eq 30 ]; then
          echo "âš ï¸  å¯åŠ¨è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡ŒéªŒè¯..."
        fi
        
        echo "ç­‰å¾…å®¹å™¨å¯åŠ¨... ($i/30)"
        sleep 2
      done
      echo ""
      
      # 6. éªŒè¯éƒ¨ç½²
      echo "æ­¥éª¤6: éªŒè¯éƒ¨ç½²"
      echo "å½“å‰å®¹å™¨çŠ¶æ€:"
      docker-compose ps || docker ps --filter "name=webcalc" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      echo ""
      
      echo "ğŸ”µ éªŒè¯è“è‰²å®¹å™¨ (ç«¯å£ ${{ env.BLUE_PORT }})"
      if curl -s -f --max-time 10 http://localhost:${{ env.BLUE_PORT }}/health > /dev/null; then
        BLUE_RESPONSE=$(curl -s http://localhost:${{ env.BLUE_PORT }}/health | head -c 100)
        echo "âœ… è“è‰²å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡"
        echo "   å“åº”: $BLUE_RESPONSE"
      else
        echo "âŒ è“è‰²å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
        echo "   æ£€æŸ¥æ—¥å¿—: docker logs webcalc_blue --tail=10"
      fi
      echo ""
      
      echo "ğŸŸ¢ éªŒè¯ç»¿è‰²å®¹å™¨ (ç«¯å£ ${{ env.GREEN_PORT }})"
      if curl -s -f --max-time 10 http://localhost:${{ env.GREEN_PORT }}/health > /dev/null; then
        GREEN_RESPONSE=$(curl -s http://localhost:${{ env.GREEN_PORT }}/health | head -c 100)
        echo "âœ… ç»¿è‰²å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡"
        echo "   å“åº”: $GREEN_RESPONSE"
      else
        echo "âŒ ç»¿è‰²å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
        echo "   æ£€æŸ¥æ—¥å¿—: docker logs webcalc_green --tail=10"
      fi
      echo ""
      
      echo "ğŸŒ éªŒè¯Nginxä»£ç†"
      for i in {1..3}; do
        if curl -s -f --max-time 5 http://localhost/health > /dev/null; then
          PROXY_RESPONSE=$(curl -s http://localhost/health | head -c 100)
          echo "âœ… ä»£ç†è¯·æ±‚ $i: æˆåŠŸ ($PROXY_RESPONSE)"
        else
          echo "âŒ ä»£ç†è¯·æ±‚ $i: å¤±è´¥"
        fi
        sleep 1
      done
      echo ""
      
      # 7. ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      echo "æ­¥éª¤7: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š"
      IP=$(hostname -I | awk '{print $1}')
      echo "========================================"
      echo "           éƒ¨ç½²å®ŒæˆæŠ¥å‘Š"
      echo "========================================"
      echo "âœ… è“ç»¿éƒ¨ç½²æˆåŠŸå®Œæˆ"
      echo ""
      echo "ğŸ”µ è“è‰²å®¹å™¨:"
      echo "   é•œåƒ: ghcr.io/${{ github.repository }}:${{ env.SHORT_SHA }}"
      echo "   ç«¯å£: ${{ env.BLUE_PORT }}"
      echo "   è®¿é—®: http://$IP:${{ env.BLUE_PORT }}/health"
      echo ""
      echo "ğŸŸ¢ ç»¿è‰²å®¹å™¨:"
      echo "   é•œåƒ: ghcr.io/${{ github.repository }}:latest"
      echo "   ç«¯å£: ${{ env.GREEN_PORT }}"
      echo "   è®¿é—®: http://$IP:${{ env.GREEN_PORT }}/health"
      echo ""
      echo "ğŸŒ è´Ÿè½½å‡è¡¡è®¿é—®:"
      echo "   http://$IP/health"
      echo ""
      echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
      docker ps --filter "name=webcalc" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}" | grep -v "NAMES"
      echo ""
      echo "éƒ¨ç½²æ—¶é—´: $(date)"
      echo "========================================"
      
      # ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
      echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ" > /tmp/deploy_success.txt
      
      EOF
      
      chmod +x /tmp/deploy_blue_green.sh
      echo "éƒ¨ç½²è„šæœ¬å·²åˆ›å»º"
  
  - name: Deploy to VM
    env:
      VM_HOST: ${{ secrets.VM_HOST }}
      VM_USER: ${{ secrets.VM_USER }}
    run: |
      echo "å¤åˆ¶éƒ¨ç½²è„šæœ¬åˆ°VM..."
      scp /tmp/deploy_blue_green.sh $VM_USER@$VM_HOST:/tmp/deploy_blue_green.sh
      
      echo "æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
      ssh $VM_USER@$VM_HOST "bash /tmp/deploy_blue_green.sh"
      
      echo "æ£€æŸ¥éƒ¨ç½²ç»“æœ..."
      if ssh $VM_USER@$VM_HOST "test -f /tmp/deploy_success.txt"; then
        echo "âœ… éƒ¨ç½²æˆåŠŸç¡®è®¤æ–‡ä»¶å­˜åœ¨"
      else
        echo "âš ï¸  éƒ¨ç½²ç¡®è®¤æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½†è„šæœ¬å¯èƒ½å·²æˆåŠŸæ‰§è¡Œ"
      fi
      
      echo "è·å–éƒ¨ç½²æ‘˜è¦..."
      ssh $VM_USER@$VM_HOST "echo '=== éƒ¨ç½²æ‘˜è¦ ===' && \
        echo 'è“è‰²å®¹å™¨ç«¯å£: ${{ env.BLUE_PORT }}' && \
        echo 'ç»¿è‰²å®¹å™¨ç«¯å£: ${{ env.GREEN_PORT }}' && \
        docker ps --filter 'name=webcalc' --format 'table {{.Names}}\t{{.Status}}'"

  verification:
    name: Verify Deployment
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Setup SSH for verification
        env:
          VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$VM_PASSWORD" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts
        
      - name: Run comprehensive verification
        env:
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
        run: |
          echo "æ‰§è¡Œç»¼åˆéªŒè¯..."
          
          cat > /tmp/verify.sh << 'EOF'
          #!/bin/bash
          echo "ğŸ”µğŸŸ¢ è“ç»¿éƒ¨ç½²ç»¼åˆéªŒè¯"
          echo "======================"
          
          # 1. éªŒè¯ç«¯å£
          echo "1. ç«¯å£éªŒè¯:"
          echo "ğŸ”µ æµ‹è¯•ç«¯å£ ${{ env.BLUE_PORT }}:"
          if curl -s -o /dev/null -w "çŠ¶æ€ç : %{http_code}\n" --max-time 5 http://localhost:${{ env.BLUE_PORT }}/health; then
            echo "âœ… ç«¯å£${{ env.BLUE_PORT }}æ­£å¸¸"
          else
            echo "âŒ ç«¯å£${{ env.BLUE_PORT }}å¼‚å¸¸"
          fi
          
          echo "ğŸŸ¢ æµ‹è¯•ç«¯å£ ${{ env.GREEN_PORT }}:"
          if curl -s -o /dev/null -w "çŠ¶æ€ç : %{http_code}\n" --max-time 5 http://localhost:${{ env.GREEN_PORT }}/health; then
            echo "âœ… ç«¯å£${{ env.GREEN_PORT }}æ­£å¸¸"
          else
            echo "âŒ ç«¯å£${{ env.GREEN_PORT }}å¼‚å¸¸"
          fi
          
          # 2. éªŒè¯è´Ÿè½½å‡è¡¡
          echo ""
          echo "2. è´Ÿè½½å‡è¡¡éªŒè¯:"
          echo "è¿ç»­è®¿é—®5æ¬¡è´Ÿè½½å‡è¡¡:"
          for i in {1..5}; do
            RESPONSE=$(curl -s http://localhost/health | head -c 50)
            echo "   è¯·æ±‚#$i: $RESPONSE"
            sleep 0.5
          done
          
          # 3. ç”ŸæˆéªŒè¯æŠ¥å‘Š
          echo ""
          echo "3. éªŒè¯æŠ¥å‘Š:"
          IP=$(hostname -I | awk '{print $1}')
          echo "è®¿é—®åœ°å€:"
          echo "  è“è‰²å®¹å™¨: http://$IP:${{ env.BLUE_PORT }}/health"
          echo "  ç»¿è‰²å®¹å™¨: http://$IP:${{ env.GREEN_PORT }}/health"
          echo "  è´Ÿè½½å‡è¡¡: http://$IP/health"
          
          echo ""
          echo "éªŒè¯å®Œæˆæ—¶é—´: $(date)"
          EOF
          
          chmod +x /tmp/verify.sh
          scp /tmp/verify.sh $VM_USER@$VM_HOST:/tmp/verify.sh
          ssh $VM_USER@$VM_HOST "bash /tmp/verify.sh"

    notification:
      name: Send Notification
      needs: [test, build, deploy, verification]
      runs-on: ubuntu-latest
      if: always()
      
      steps:
      - name: Determine deployment status
        id: check_status
        run: |
          if [[ ${{ needs.test.result }} == 'success' ]] && \
            [[ ${{ needs.build.result }} == 'success' ]] && \
            [[ ${{ needs.deploy.result }} == 'success' ]] && \
            [[ ${{ needs.verification.result }} == 'success' ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Send success notification
        if: steps.check_status.outputs.status == 'success'
        env:
          VM_HOST: ${{ secrets.VM_HOST }}
        run: |
          echo "âœ… CI/CD Pipeline æˆåŠŸå®Œæˆ!"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦:"
          echo "  æµ‹è¯•: âœ… é€šè¿‡"
          echo "  æ„å»º: âœ… å®Œæˆ"
          echo "  éƒ¨ç½²: âœ… æˆåŠŸ"
          echo "  éªŒè¯: âœ… é€šè¿‡"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "  è“è‰²å®¹å™¨: http://$VM_HOST:${{ env.BLUE_PORT }}/health"
          echo "  ç»¿è‰²å®¹å™¨: http://$VM_HOST:${{ env.GREEN_PORT }}/health"
          echo "  è´Ÿè½½å‡è¡¡: http://$VM_HOST/health"
          echo ""
          echo "ğŸ”— æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
          echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
      
      - name: Send failure notification
        if: steps.check_status.outputs.status == 'failure'
        run: |
          echo "âŒ CI/CD Pipeline å¤±è´¥!"
          echo ""
          echo "ğŸ“Š å¤±è´¥åˆ†æ:"
          echo "  æµ‹è¯•ç»“æœ: ${{ needs.test.result }}"
          echo "  æ„å»ºç»“æœ: ${{ needs.build.result }}"
          echo "  éƒ¨ç½²ç»“æœ: ${{ needs.deploy.result }}"
          echo "  éªŒè¯ç»“æœ: ${{ needs.verification.result }}"
          echo ""
          echo "ğŸ” æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
name: Web Calculator CI/CD

on:
  push:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest requests
    
    - name: Run unit tests
      run: |
        python -m pytest tests/unit_tests/ -v
    
    - name: Run functional tests (with longer timeout)
      run: |
        # å¯åŠ¨åº”ç”¨å¹¶è®°å½•æ—¥å¿—
        echo "å¯åŠ¨åº”ç”¨..."
        python app.py > app.log 2>&1 &
        APP_PID=$!
        
        echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
        # ç­‰å¾…æ›´é•¿æ—¶é—´
        sleep 15
        
        # æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
        if ps -p $APP_PID > /dev/null; then
          echo "åº”ç”¨è¿›ç¨‹è¿è¡Œä¸­"
        else
          echo "åº”ç”¨è¿›ç¨‹å·²é€€å‡º"
          cat app.log
          exit 1
        fi
        
        # å°è¯•è¿æ¥
        echo "æµ‹è¯•è¿æ¥..."
        if curl -s -f --max-time 5 http://localhost:5000/health > /dev/null; then
          echo "âœ… åº”ç”¨å·²å°±ç»ª"
          # è¿è¡Œæµ‹è¯•
          python -m pytest tests/functional_tests/ -v --tb=short
        else
          echo "âŒ åº”ç”¨æœªå“åº”"
          echo "=== åº”ç”¨æ—¥å¿— ==="
          tail -50 app.log
          exit 1
        fi
        
        # æ¸…ç†
        kill $APP_PID 2>/dev/null || true

  build:
    name: Build Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}

    - name: Build and push
      run: |
        docker build -t ghcr.io/${{ github.repository }}:latest -t ghcr.io/${{ github.repository }}:latest .
        docker push ghcr.io/${{ github.repository }}:latest
        docker push ghcr.io/${{ github.repository }}:latest

  deploy:
    name: Deploy to VM
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Setup SSH for deployment
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_USER: ${{ secrets.VM_USER }}
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼å†™å…¥ç§é’¥
        cat > ~/.ssh/id_rsa << 'EOF'
        ${{ secrets.VM_SSH_PRIVATE_KEY }}
        EOF
        
        chmod 600 ~/.ssh/id_rsa
        
        # æ·»åŠ ç›®æ ‡ä¸»æœºåˆ° known_hosts
        ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts
        
        # æµ‹è¯• SSH è¿æ¥
        echo "æµ‹è¯• SSH è¿æ¥..."
        ssh -o BatchMode=yes -o ConnectTimeout=5 $VM_USER@$VM_HOST "echo 'SSHè¿æ¥æˆåŠŸ'" || echo "SSHæµ‹è¯•å¤±è´¥"
        
        echo "SSHé…ç½®å®Œæˆ"
    
    - name: Create deployment script
      run: |
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬ï¼Œä½¿ç”¨å˜é‡å ä½ç¬¦
        cat > /tmp/deploy_blue_green.sh << 'DEPLOY_SCRIPT'
        #!/bin/bash
        set -e
        
        echo "========================================"
        echo "      è“ç»¿éƒ¨ç½²å¼€å§‹"
        echo "========================================"
        echo "éƒ¨ç½²æ—¶é—´: \$(date)"
        echo "é•œåƒç‰ˆæœ¬: __IMAGE_TAG__"
        echo "è“è‰²ç«¯å£: 5000"
        echo "ç»¿è‰²ç«¯å£: 5001"
        echo ""
        
        # 1. ç™»å½•åˆ°GitHubå®¹å™¨ä»“åº“
        echo "æ­¥éª¤1: ç™»å½•åˆ°GitHubå®¹å™¨ä»“åº“"
        echo "__CR_PAT__" | docker login ghcr.io -u '__ACTOR__' --password-stdin
        echo "âœ… Dockerç™»å½•æˆåŠŸ"
        echo ""
        
        # 2. æ‹‰å–é•œåƒ
        echo "æ­¥éª¤2: æ‹‰å–Dockeré•œåƒ"
        IMAGE="ghcr.io/__REPOSITORY__"
        
        echo "æ‹‰å–é•œåƒ: latest"
        docker pull "\$IMAGE":latest
        echo "âœ… æ‹‰å–latesté•œåƒæˆåŠŸ"
        
        echo "æ‹‰å–é•œåƒ: __IMAGE_TAG__"
        docker pull "\$IMAGE":__IMAGE_TAG__
        echo "âœ… æ‹‰å–__IMAGE_TAG__é•œåƒæˆåŠŸ"
        echo ""
        
        # 3. åˆ›å»ºé¡¹ç›®ç›®å½•
        echo "æ­¥éª¤3: å‡†å¤‡éƒ¨ç½²ç›®å½•"
        PROJECT_DIR="/opt/web-calculator"
        mkdir -p \$PROJECT_DIR
        cd \$PROJECT_DIR
        echo "å½“å‰ç›®å½•: \$(pwd)"
        echo ""
        
        # 4. åˆ›å»ºdocker-compose.ymlæ–‡ä»¶
        echo "æ­¥éª¤4: åˆ›å»ºdocker-compose.yml"
        cat > docker-compose.yml << 'DOCKER_COMPOSE'
        version: '3.8'
        
        services:
          webcalc_blue:
            image: ghcr.io/__REPOSITORY__:__IMAGE_TAG__
            container_name: webcalc_blue
            ports:
              - "5000:5000"
            restart: unless-stopped
        
          webcalc_green:
            image: ghcr.io/__REPOSITORY__:latest
            container_name: webcalc_green
            ports:
              - "5001:5000"
            restart: unless-stopped
        DOCKER_COMPOSE
        
        echo "âœ… docker-compose.ymlæ–‡ä»¶å·²åˆ›å»º"
        echo ""
        
        # 5. åœæ­¢æ—§æœåŠ¡
        echo "æ­¥éª¤5: åœæ­¢æ—§æœåŠ¡"
        docker-compose down 2>/dev/null || true
        echo "âœ… æ—§æœåŠ¡å·²åœæ­¢"
        echo ""
        
        # 6. å¯åŠ¨æ–°æœåŠ¡
        echo "æ­¥éª¤6: å¯åŠ¨è“ç»¿éƒ¨ç½²"
        docker-compose up -d --force-recreate
        echo "âœ… æœåŠ¡å¯åŠ¨å‘½ä»¤å·²æ‰§è¡Œ"
        echo ""
        
        # 7. ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "æ­¥éª¤7: ç­‰å¾…æœåŠ¡å¯åŠ¨"
        for i in {1..30}; do
          BLUE_UP=\$(docker ps | grep -c "webcalc_blue" || true)
          GREEN_UP=\$(docker ps | grep -c "webcalc_green" || true)
          
          if [ \$BLUE_UP -eq 1 ] && [ \$GREEN_UP -eq 1 ]; then
            echo "âœ… è“ç»¿å®¹å™¨éƒ½å·²å¯åŠ¨"
            break
          fi
          
          if [ \$i -eq 30 ]; then
            echo "âš ï¸  å¯åŠ¨è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡ŒéªŒè¯..."
          fi
          
          echo "ç­‰å¾…å®¹å™¨å¯åŠ¨... (\$i/30)"
          sleep 2
        done
        echo ""
        
        # 8. éªŒè¯éƒ¨ç½²
        echo "æ­¥éª¤8: éªŒè¯éƒ¨ç½²"
        echo "å½“å‰å®¹å™¨çŠ¶æ€:"
        docker-compose ps || docker ps --filter "name=webcalc" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        echo ""
        
        echo "ğŸ”µ éªŒè¯è“è‰²å®¹å™¨ (ç«¯å£ 5000)"
        if curl -s -f --max-time 10 http://localhost:5000/health > /dev/null; then
          BLUE_RESPONSE=\$(curl -s http://localhost:5000/health | head -c 100)
          echo "âœ… è“è‰²å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "   å“åº”: \$BLUE_RESPONSE"
        else
          echo "âŒ è“è‰²å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
          echo "   æ£€æŸ¥æ—¥å¿—: docker logs webcalc_blue --tail=10"
        fi
        echo ""
        
        echo "ğŸŸ¢ éªŒè¯ç»¿è‰²å®¹å™¨ (ç«¯å£ 5001)"
        if curl -s -f --max-time 10 http://localhost:5001/health > /dev/null; then
          GREEN_RESPONSE=\$(curl -s http://localhost:5001/health | head -c 100)
          echo "âœ… ç»¿è‰²å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡"
          echo "   å“åº”: \$GREEN_RESPONSE"
        else
          echo "âŒ ç»¿è‰²å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
          echo "   æ£€æŸ¥æ—¥å¿—: docker logs webcalc_green --tail=10"
        fi
        echo ""
        
        # 9. ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        echo "æ­¥éª¤9: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š"
        IP=\$(hostname -I | awk '{print \$1}')
        echo "========================================"
        echo "           éƒ¨ç½²å®ŒæˆæŠ¥å‘Š"
        echo "========================================"
        echo "âœ… è“ç»¿éƒ¨ç½²æˆåŠŸå®Œæˆ"
        echo ""
        echo "ğŸ”µ è“è‰²å®¹å™¨:"
        echo "   é•œåƒ: ghcr.io/__REPOSITORY__:__IMAGE_TAG__"
        echo "   ç«¯å£: 5000"
        echo "   è®¿é—®: http://\$IP:5000/health"
        echo ""
        echo "ğŸŸ¢ ç»¿è‰²å®¹å™¨:"
        echo "   é•œåƒ: ghcr.io/__REPOSITORY__:latest"
        echo "   ç«¯å£: 5001"
        echo "   è®¿é—®: http://\$IP:5001/health"
        echo ""
        echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
        docker ps --filter "name=webcalc" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}\t{{.Image}}" | grep -v "NAMES"
        echo ""
        echo "éƒ¨ç½²æ—¶é—´: \$(date)"
        echo "========================================"
        
        # ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
        echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ" > /tmp/deploy_success.txt
        DEPLOY_SCRIPT
        
        # æ›¿æ¢å ä½ç¬¦
        sed -i "s|__REPOSITORY__|${{ github.repository }}|g" /tmp/deploy_blue_green.sh
        sed -i "s|__IMAGE_TAG__|latest|g" /tmp/deploy_blue_green.sh
        sed -i "s|__ACTOR__|${{ github.actor }}|g" /tmp/deploy_blue_green.sh
        
        # æ³¨æ„ï¼šCR_PAT åœ¨è¿è¡Œæ—¶æ›¿æ¢ï¼Œä¸åœ¨æ–‡ä»¶ä¸­ç¡¬ç¼–ç 
        chmod +x /tmp/deploy_blue_green.sh
        echo "éƒ¨ç½²è„šæœ¬å·²åˆ›å»º"
    
    - name: Copy and execute deployment script
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_USER: ${{ secrets.VM_USER }}
        CR_PAT: ${{ secrets.CR_PAT }}
      run: |
        echo "å¤åˆ¶éƒ¨ç½²è„šæœ¬åˆ°VM..."
        scp -o ConnectTimeout=30 /tmp/deploy_blue_green.sh $VM_USER@$VM_HOST:/tmp/deploy_blue_green.sh
        
        # å¤åˆ¶ CR_PAT åˆ°è¿œç¨‹ç¯å¢ƒå˜é‡æ–‡ä»¶
        echo "é…ç½®ç¯å¢ƒå˜é‡..."
        ssh $VM_USER@$VM_HOST "echo 'export CR_PAT=\"$CR_PAT\"' > /tmp/deploy_env.sh"
        
        echo "æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
        # ä½¿ç”¨ç¯å¢ƒå˜é‡æ›¿æ¢ CR_PAT å ä½ç¬¦å¹¶æ‰§è¡Œ
        ssh $VM_USER@$VM_HOST "
          source /tmp/deploy_env.sh && \
          sed -i \"s|__CR_PAT__|\\\$CR_PAT|g\" /tmp/deploy_blue_green.sh && \
          bash /tmp/deploy_blue_green.sh
        "
        
        echo "æ£€æŸ¥éƒ¨ç½²ç»“æœ..."
        if ssh $VM_USER@$VM_HOST "test -f /tmp/deploy_success.txt"; then
          echo "âœ… éƒ¨ç½²æˆåŠŸç¡®è®¤æ–‡ä»¶å­˜åœ¨"
        else
          echo "âš ï¸  éƒ¨ç½²ç¡®è®¤æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½†è„šæœ¬å¯èƒ½å·²æˆåŠŸæ‰§è¡Œ"
        fi
        
        echo "è·å–éƒ¨ç½²æ‘˜è¦..."
        ssh $VM_USER@$VM_HOST "echo '=== éƒ¨ç½²æ‘˜è¦ ===' && \
          echo 'è“è‰²å®¹å™¨ç«¯å£: 5000' && \
          echo 'ç»¿è‰²å®¹å™¨ç«¯å£: 5001' && \
          docker ps --filter 'name=webcalc' --format 'table {{.Names}}\t{{.Status}}'"

  verification:
    name: Verify Deployment
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Setup SSH for verification
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_USER: ${{ secrets.VM_USER }}
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts
      
    - name: Run comprehensive verification
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_USER: ${{ secrets.VM_USER }}
      run: |
        echo "æ‰§è¡Œç»¼åˆéªŒè¯..."
        
        cat > /tmp/verify.sh << 'EOF'
        #!/bin/bash
        echo "ğŸ”µğŸŸ¢ è“ç»¿éƒ¨ç½²ç»¼åˆéªŒè¯"
        echo "======================"
        
        # 1. éªŒè¯ç«¯å£
        echo "1. ç«¯å£éªŒè¯:"
        echo "ğŸ”µ æµ‹è¯•ç«¯å£ 5000:"
        if curl -s -o /dev/null -w "çŠ¶æ€ç : %{http_code}\n" --max-time 5 http://localhost:5000/health; then
          echo "âœ… ç«¯å£5000æ­£å¸¸"
        else
          echo "âŒ ç«¯å£5000å¼‚å¸¸"
        fi
        
        echo "ğŸŸ¢ æµ‹è¯•ç«¯å£ 5001:"
        if curl -s -o /dev/null -w "çŠ¶æ€ç : %{http_code}\n" --max-time 5 http://localhost:5001/health; then
          echo "âœ… ç«¯å£5001æ­£å¸¸"
        else
          echo "âŒ ç«¯å£5001å¼‚å¸¸"
        fi
        
        # 2. ç”ŸæˆéªŒè¯æŠ¥å‘Š
        echo ""
        echo "2. éªŒè¯æŠ¥å‘Š:"
        IP=$(hostname -I | awk '{print $1}')
        echo "è®¿é—®åœ°å€:"
        echo "  è“è‰²å®¹å™¨: http://$IP:5000/health"
        echo "  ç»¿è‰²å®¹å™¨: http://$IP:5001/health"
        
        echo ""
        echo "éªŒè¯å®Œæˆæ—¶é—´: $(date)"
        EOF
        
        chmod +x /tmp/verify.sh
        scp -o ConnectTimeout=30 /tmp/verify.sh $VM_USER@$VM_HOST:/tmp/verify.sh
        ssh $VM_USER@$VM_HOST "bash /tmp/verify.sh"

  notification:
    name: Send Notification
    needs: [test, build, deploy, verification]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Determine deployment status
      id: check_status
      run: |
        if [[ ${{ needs.test.result }} == 'success' ]] && \
            [[ ${{ needs.build.result }} == 'success' ]] && \
            [[ ${{ needs.deploy.result }} == 'success' ]] && \
            [[ ${{ needs.verification.result }} == 'success' ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi
    
    - name: Send success notification
      if: steps.check_status.outputs.status == 'success'
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
      run: |
        echo "âœ… CI/CD Pipeline æˆåŠŸå®Œæˆ!"
        echo ""
        echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦:"
        echo "  æµ‹è¯•: âœ… é€šè¿‡"
        echo "  æ„å»º: âœ… å®Œæˆ"
        echo "  éƒ¨ç½²: âœ… æˆåŠŸ"
        echo "  éªŒè¯: âœ… é€šè¿‡"
        echo ""
        echo "ğŸŒ è®¿é—®åœ°å€:"
        echo "  è“è‰²å®¹å™¨: http://$VM_HOST:5000/health"
        echo "  ç»¿è‰²å®¹å™¨: http://$VM_HOST:5001/health"
        echo ""
        echo "ğŸ”— æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
        echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
    
    - name: Send failure notification
      if: steps.check_status.outputs.status == 'failure'
      run: |
        echo "âŒ CI/CD Pipeline å¤±è´¥!"
        echo ""
        echo "ğŸ“Š å¤±è´¥åˆ†æ:"
        echo "  æµ‹è¯•ç»“æœ: ${{ needs.test.result }}"
        echo "  æ„å»ºç»“æœ: ${{ needs.build.result }}"
        echo "  éƒ¨ç½²ç»“æœ: ${{ needs.deploy.result }}"
        echo "  éªŒè¯ç»“æœ: ${{ needs.verification.result }}"
        echo ""
        echo "ğŸ” æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"